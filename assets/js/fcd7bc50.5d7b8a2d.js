"use strict";(self.webpackChunkkro_docs=self.webpackChunkkro_docs||[]).push([[4239],{90871:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"examples/aws/deploying-controller","title":"Controller Deployment","description":"","source":"@site/versioned_docs/version-0.2.1/examples/aws/deploying-controller.md","sourceDirName":"examples/aws","slug":"/examples/aws/deploying-controller","permalink":"/kro/0.2.1/examples/aws/deploying-controller","draft":false,"unlisted":false,"editUrl":"https://github.com/kubernetes-sigs/kro/tree/main/website/versioned_docs/version-0.2.1/examples/aws/deploying-controller.md","tags":[],"version":"0.2.1","sidebarPosition":305,"frontMatter":{"sidebar_position":305},"sidebar":"examplesSidebar","previous":{"title":"Valkey cluster","permalink":"/kro/0.2.1/examples/aws/ack-valkey-cachecluster"},"next":{"title":"Pod with RDS DBInstance","permalink":"/kro/0.2.1/examples/aws/pod-rds-dbinstance"}}');var t=s(74848),r=s(28453);const o={sidebar_position:305},c="Controller Deployment",i={},l=[];function m(e){const n={code:"code",h1:"h1",header:"header",pre:"pre",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"controller-deployment",children:"Controller Deployment"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",metastring:'title="controller-rg.yaml"',children:'apiVersion: kro.run/v1alpha1\nkind: ResourceGraphDefinition\nmetadata:\n  name: ekscontrollers.kro.run\nspec:\n  schema:\n    apiVersion: v1alpha1\n    kind: EKSController\n    spec:\n      name: string | default=eks-controller\n      namespace: string | default=default\n      values:\n        aws:\n          accountID: string | required=true\n          region: string | default=us-west-2\n        deployment:\n          containerPort: integer | default=8080\n          replicas: integer | default=1\n        iamRole:\n          maxSessionDuration: integer | default=3600\n          oidcProvider: string | required=true\n          roleDescription: string | default=IRSA role for ACK EKS controller deployment on EKS cluster using kro Resource group\n        iamPolicy:\n          # would prefer to add a policyDocument here, need to support multiline string here\n          description: string | default="policy for eks controller"\n        image:\n          deletePolicy: string | default=delete\n          repository: string | default=public.ecr.aws/aws-controllers-k8s/eks-controller\n          tag: string | default=1.4.7\n          resources:\n            requests:\n              memory: string | default=64Mi\n              cpu: string | default=50m\n            limits:\n              memory: string | default=128Mi\n              cpu: string | default=100m\n        log:\n          enabled: boolean | default=false\n          level: string | default=info\n        serviceAccount:\n          name: string | default=eks-controller-sa\n  resources:\n  - id: eksCRDGroup\n    template:\n      apiVersion: kro.run/v1alpha1\n      kind: EKSCRDGroup\n      metadata:\n        name: ${schema.spec.name}-crd-group\n      spec:\n        name: ${schema.spec.name}-crd-group\n  - id: eksControllerIamPolicy\n    template:\n      apiVersion: iam.services.k8s.aws/v1alpha1\n      kind: Policy\n      metadata:\n        name: ${schema.spec.name}-iam-policy\n      spec:\n        name: ${schema.spec.name}-iam-policy\n        description: ${schema.spec.values.iamPolicy.description}\n        policyDocument: >\n          {\n            "Version": "2012-10-17",\n            "Statement": [\n              {\n                "Sid": "VisualEditor0",\n                "Effect": "Allow",\n                "Action": [\n                  "eks:*",\n                  "iam:GetRole",\n                  "iam:PassRole",\n                  "iam:ListAttachedRolePolicies",\n                  "ec2:DescribeSubnets"\n                ],\n                "Resource": "*"\n              }\n            ]\n          }\n  - id: eksControllerIamRole\n    template:\n      apiVersion: iam.services.k8s.aws/v1alpha1\n      kind: Role\n      metadata:\n        name: ${schema.spec.name}-iam-role\n        namespace: ${schema.spec.namespace}\n      spec:\n        name: ${schema.spec.name}-iam-role\n        description: ${schema.spec.values.iamRole.roleDescription}\n        maxSessionDuration: ${schema.spec.values.iamRole.maxSessionDuration}\n        policies:\n        - ${eksControllerIamPolicy.status.ackResourceMetadata.arn}\n        assumeRolePolicyDocument: >\n          {\n            "Version":"2012-10-17",\n            "Statement": [{\n              "Effect":"Allow",\n              "Principal": {"Federated": "arn:aws:iam::${schema.spec.values.aws.accountID}:oidc-provider/${schema.spec.values.iamRole.oidcProvider}"},\n              "Action": ["sts:AssumeRoleWithWebIdentity"],\n              "Condition": {\n                "StringEquals": {"${schema.spec.values.iamRole.oidcProvider}:sub": "system:serviceaccount:${schema.spec.namespace}:${schema.spec.values.serviceAccount.name}"}\n              }\n            }]\n          }\n  - id: serviceAccount\n    template:\n      apiVersion: v1\n      kind: ServiceAccount\n      metadata:\n        name: ${schema.spec.values.serviceAccount.name}\n        namespace: ${schema.spec.namespace}\n        annotations:\n          eks.amazonaws.com/role-arn : ${eksControllerIamRole.status.ackResourceMetadata.arn}\n  - id: deployment\n    template:\n      apiVersion: apps/v1\n      kind: Deployment\n      metadata:\n        name: ${schema.spec.name}-deployment\n        namespace: ${schema.spec.namespace}\n        labels:\n          app.kubernetes.io.name: ${schema.spec.name}-deployment\n          app.kubernetes.io.instance: ${schema.spec.name}\n      spec:\n        replicas: ${schema.spec.values.deployment.replicas}\n        selector:\n          matchLabels:\n            app.kubernetes.io.name: ${schema.spec.name}-deployment\n            app.kubernetes.io.instance: ${schema.spec.name}\n        template:\n          metadata:\n            labels:\n              app.kubernetes.io.name: ${schema.spec.name}-deployment\n              app.kubernetes.io.instance: ${schema.spec.name}\n          spec:\n            serviceAccountName: ${serviceAccount.metadata.name}\n            containers:\n            - command:\n              - ./bin/controller\n              args:\n              - --aws-region\n              - ${schema.spec.values.aws.region}\n              - --enable-development-logging=${schema.spec.values.log.enabled}\n              - --log-level\n              - ${schema.spec.values.log.level}\n              - --deletion-policy\n              - ${schema.spec.values.image.deletePolicy}\n              - --watch-namespace\n              - ${schema.spec.namespace}\n              image: ${schema.spec.values.image.repository}:${schema.spec.values.image.tag}\n              name: controller\n              ports:\n                - name: http\n                  containerPort: ${schema.spec.values.deployment.containerPort}\n              resources:\n                requests:\n                  memory: ${schema.spec.values.image.resources.requests.memory}\n                  cpu: ${schema.spec.values.image.resources.requests.cpu}\n                limits:\n                    memory: ${schema.spec.values.image.resources.limits.memory}\n                    cpu: ${schema.spec.values.image.resources.limits.cpu}\n              env:\n              - name: ACK_SYSTEM_NAMESPACE\n                value: ${schema.spec.namespace}\n              - name: AWS_REGION\n                value: ${schema.spec.values.aws.region}\n              - name: DELETE_POLICY\n                value: ${schema.spec.values.image.deletePolicy}\n              - name: ACK_LOG_LEVEL\n                value: ${schema.spec.values.log.level}\n              ports:\n              - containerPort: 80\n  - id: clusterRoleBinding\n    template:\n      apiVersion: rbac.authorization.k8s.io/v1\n      kind: ClusterRoleBinding\n      metadata:\n        name: ${schema.spec.name}-clusterrolebinding\n      roleRef:\n        kind: ClusterRole\n        apiGroup: rbac.authorization.k8s.io\n        name: ${clusterRole.metadata.name}\n      subjects:\n      - kind: ServiceAccount\n        name: ${serviceAccount.metadata.name}\n        namespace: ${serviceAccount.metadata.namespace}\n  - id: clusterRole\n    template:\n      apiVersion: rbac.authorization.k8s.io/v1\n      kind: ClusterRole\n      metadata:\n        name: ${schema.spec.name}-clusterrole\n      rules:\n      - apiGroups:\n        - ""\n        resources:\n        - configmaps\n        - secrets\n        verbs:\n        - get\n        - list\n        - patch\n        - watch\n      - apiGroups:\n        - ""\n        resources:\n        - namespaces\n        verbs:\n        - get\n        - list\n        - watch\n      - apiGroups:\n        - ec2.services.k8s.aws\n        resources:\n        - securitygroups\n        - securitygroups/status\n        - subnets\n        - subnets/status\n        verbs:\n        - get\n        - list\n      - apiGroups:\n        - eks.services.k8s.aws\n        resources:\n        - accessentries\n        - addons\n        - clusters\n        - fargateprofiles\n        - identityproviderconfigs\n        - nodegroups\n        - podidentityassociations\n        verbs:\n        - create\n        - delete\n        - get\n        - list\n        - patch\n        - update\n        - watch\n      - apiGroups:\n        - eks.services.k8s.aws\n        resources:\n        - accessentries/status\n        - addons/status\n        - clusters/status\n        - fargateprofiles/status\n        - identityproviderconfigs/status\n        - nodegroups/status\n        - podidentityassociations/status\n        verbs:\n        - get\n        - patch\n        - update\n      - apiGroups:\n        - iam.services.k8s.aws\n        resources:\n        - roles\n        - roles/status\n        verbs:\n        - get\n        - list\n      - apiGroups:\n        - kms.services.k8s.aws\n        resources:\n        - keys\n        - keys/status\n        verbs:\n        - get\n        - list\n      - apiGroups:\n        - services.k8s.aws\n        resources:\n        - adoptedresources\n        - fieldexports\n        verbs:\n        - create\n        - delete\n        - get\n        - list\n        - patch\n        - update\n        - watch\n      - apiGroups:\n        - services.k8s.aws\n        resources:\n        - adoptedresources/status\n        - fieldexports/status\n        verbs:\n        - get\n        - patch\n        - update\n'})})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(m,{...e})}):m(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>o,x:()=>c});var a=s(96540);const t={},r=a.createContext(t);function o(e){const n=a.useContext(r);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:o(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);