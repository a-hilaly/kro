"use strict";(self.webpackChunkkro_docs=self.webpackChunkkro_docs||[]).push([[1163],{25554:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>t,contentTitle:()=>r,default:()=>d,frontMatter:()=>c,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"examples/gcp/cloud-sql","title":"CloudSQL","description":"This example show how you can use KRO to deploy GCP Cloud SQL instance in 2 regions as a primary and replica instances.","source":"@site/versioned_docs/version-0.6.3/examples/gcp/cloud-sql.md","sourceDirName":"examples/gcp","slug":"/examples/gcp/cloud-sql","permalink":"/examples/gcp/cloud-sql","draft":false,"unlisted":false,"editUrl":"https://github.com/kubernetes-sigs/kro/tree/main/website/versioned_docs/version-0.6.3/examples/gcp/cloud-sql.md","tags":[],"version":"0.6.3","sidebarPosition":406,"frontMatter":{"sidebar_position":406},"sidebar":"examplesSidebar","previous":{"title":"GKECluster","permalink":"/examples/gcp/gke-cluster"},"next":{"title":"GCSBucketWithFinalizerTrigger","permalink":"/examples/gcp/eventarc"}}');var i=a(74848),o=a(28453);const c={sidebar_position:406},r="CloudSQL",t={},l=[{value:"End User: CloudSQL",id:"end-user-cloudsql",level:2},{value:"Administrator: ResourceGraphDefinition",id:"administrator-resourcegraphdefinition",level:2}];function m(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,o.R)(),...e.components},{Details:a}=n;return a||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"cloudsql",children:"CloudSQL"})}),"\n",(0,i.jsx)(n.p,{children:"This example show how you can use KRO to deploy GCP Cloud SQL instance in 2 regions as a primary and replica instances."}),"\n",(0,i.jsx)(n.h2,{id:"end-user-cloudsql",children:"End User: CloudSQL"}),"\n",(0,i.jsxs)(n.p,{children:["The administrator needs to install the RGD first.\nThe end user creates a ",(0,i.jsx)(n.code,{children:"CloudSQL"})," resource that looks like this:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: kro.run/v1alpha1\nkind: CloudSQL\nmetadata:\n  name: demo\n  namespace: config-connector\nspec:\n  name: demo\n  project: my-gcp-project\n  primaryRegion: us-central1\n  replicaRegion: us-west1\n"})}),"\n",(0,i.jsx)(n.p,{children:"The status of the applied resource can be checked using:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kubectl get cloudsqls\nkubectl get cloudsql demo -n config-connector -o yaml\n"})}),"\n",(0,i.jsx)(n.p,{children:"Navigate to CloudSQL page in the GCP Console and verify the creation of primary and replica instances."}),"\n",(0,i.jsxs)(n.p,{children:["Once done, the user can delete the ",(0,i.jsx)(n.code,{children:"CloudSQL"})," instance:"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kubectl delete cloudsql demo -n config-connector\n"})}),"\n",(0,i.jsx)(n.h2,{id:"administrator-resourcegraphdefinition",children:"Administrator: ResourceGraphDefinition"}),"\n",(0,i.jsx)(n.p,{children:"The administrator needs to install the RGD in the cluster first before the user can consume it:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"kubectl apply -f rgd.yaml\n"})}),"\n",(0,i.jsx)(n.p,{children:"Validate the RGD is installed correctly:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"> kubectl get rgd cloudsql.kro.run\nNAME               APIVERSION   KIND       STATE    AGE\ncloudsql.kro.run   v1alpha1     CloudSQL   Active   44m\n"})}),"\n",(0,i.jsx)(n.p,{children:"Once all user created instances are deleted, the administrator can choose to deleted the RGD."}),"\n",(0,i.jsxs)(a,{children:[(0,i.jsx)("summary",{children:"ResourceGraphDefinition"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",metastring:'title="rgd.yaml"',children:'apiVersion: kro.run/v1alpha1\nkind: ResourceGraphDefinition\nmetadata:\nname: cloudsql.kro.run\nspec:\nschema:\n  apiVersion: v1alpha1\n  kind: CloudSQL\n  spec:\n    name: string\n    project: string\n    primaryRegion: string\n    replicaRegion: string\n  status:\n    connectionName: ${sqlPrimary.status.connectionName}\n    ipAddress: ${sqlPrimary.status.firstIpAddress}\nresources:\n- id: cloudkmsEnable\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: Service\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: "abandon"\n        cnrm.cloud.google.com/disable-dependent-services: "false"\n      name: cloudkms-enablement\n    spec:\n      resourceID: cloudkms.googleapis.com\n- id: iamEnable\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: Service\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: "abandon"\n        cnrm.cloud.google.com/disable-dependent-services: "false"\n      name: iam-enablement\n    spec:\n      resourceID: iam.googleapis.com\n- id: serviceUsageEnable\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: Service\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: "abandon"\n        cnrm.cloud.google.com/disable-dependent-services: "false"\n      name: serviceusage-enablement\n    spec:\n      resourceID: serviceusage.googleapis.com\n- id: sqlAdminEnable\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: Service\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: "abandon"\n        cnrm.cloud.google.com/disable-dependent-services: "false"\n      name: sqladmin-enablement\n    spec:\n      resourceID: sqladmin.googleapis.com\n- id: serviceidentity\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: ServiceIdentity\n    metadata:\n      labels:\n        enabled-service: ${serviceUsageEnable.metadata.name}\n      name: sqladmin.googleapis.com\n    spec:\n      projectRef:\n        external: ${schema.spec.project}\n- id: keyringPrimary\n  template:\n    apiVersion: kms.cnrm.cloud.google.com/v1beta1\n    kind: KMSKeyRing\n    metadata:\n      labels:\n        enabled-service: ${cloudkmsEnable.metadata.name}\n      name: ${schema.spec.name}-primary\n    spec:\n      location: ${schema.spec.primaryRegion}\n- id: keyringReplica\n  template:\n    apiVersion: kms.cnrm.cloud.google.com/v1beta1\n    kind: KMSKeyRing\n    metadata:\n      labels:\n        enabled-service: ${cloudkmsEnable.metadata.name}\n      name: ${schema.spec.name}-replica\n    spec:\n      location: ${schema.spec.replicaRegion}\n- id: kmskeyPrimary\n  template:\n    apiVersion: kms.cnrm.cloud.google.com/v1beta1\n    kind: KMSCryptoKey\n    metadata:\n      labels:\n        enabled-service: ${cloudkmsEnable.metadata.name}\n        failure-zone: ${schema.spec.primaryRegion}\n      name: ${schema.spec.name}-primary\n    spec:\n      keyRingRef:\n        name: ${keyringPrimary.metadata.name}\n        #namespace: {{ cloudsqls.metadata.namespace }}\n      purpose: ENCRYPT_DECRYPT\n      versionTemplate:\n        algorithm: GOOGLE_SYMMETRIC_ENCRYPTION\n        protectionLevel: SOFTWARE\n      importOnly: false\n- id: kmskeyReplica\n  template:\n    apiVersion: kms.cnrm.cloud.google.com/v1beta1\n    kind: KMSCryptoKey\n    metadata:\n      labels:\n        enabled-service: ${cloudkmsEnable.metadata.name}\n        failure-zone: ${schema.spec.replicaRegion}\n      name: ${schema.spec.name}-replica\n    spec:\n      keyRingRef:\n        name: ${keyringReplica.metadata.name}\n        #namespace: {{ cloudsqls.metadata.namespace }}\n      purpose: ENCRYPT_DECRYPT\n      versionTemplate:\n        algorithm: GOOGLE_SYMMETRIC_ENCRYPTION\n        protectionLevel: SOFTWARE\n      importOnly: false\n- id: iampolicymemberPrimary\n  template:\n    apiVersion: iam.cnrm.cloud.google.com/v1beta1\n    kind: IAMPolicyMember\n    metadata:\n      labels:\n        enabled-service: ${iamEnable.metadata.name}\n      name: sql-kms-${schema.spec.primaryRegion}-policybinding\n    spec:\n      member: serviceAccount:${serviceidentity.status.email}\n      role: roles/cloudkms.cryptoKeyEncrypterDecrypter\n      resourceRef:\n        kind: KMSCryptoKey\n        name: ${kmskeyPrimary.metadata.name}-primary\n        #namespace: {{ cloudsqls.metadata.namespace }}\n- id: iampolicymemberReplica\n  template:\n    apiVersion: iam.cnrm.cloud.google.com/v1beta1\n    kind: IAMPolicyMember\n    metadata:\n      name: sql-kms-${schema.spec.replicaRegion}-policybinding\n      labels:\n        enabled-service: ${iamEnable.metadata.name}\n    spec:\n      member: serviceAccount:${serviceidentity.status.email}\n      role: roles/cloudkms.cryptoKeyEncrypterDecrypter\n      resourceRef:\n        kind: KMSCryptoKey\n        name: ${kmskeyReplica.metadata.name}-replica\n        #namespace: {{ cloudsqls.metadata.namespace }}\n- id: sqlPrimary\n  template:\n    apiVersion: sql.cnrm.cloud.google.com/v1beta1\n    kind: SQLInstance\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: abandon\n      labels:\n        failure-zone: ${schema.spec.primaryRegion}\n        enabled-service: ${sqlAdminEnable.metadata.name}\n      name: ${schema.spec.name}-primary\n    spec:\n      databaseVersion: POSTGRES_13\n      encryptionKMSCryptoKeyRef:\n        external: projects/${schema.spec.project}/locations/${schema.spec.primaryRegion}/keyRings/${keyringPrimary.metadata.name}/cryptoKeys/${kmskeyPrimary.metadata.name}\n      region: ${schema.spec.primaryRegion}\n      settings:\n        availabilityType: REGIONAL\n        backupConfiguration:\n          backupRetentionSettings:\n            retainedBackups: 6\n          enabled: true\n          location: us\n        diskSize: 50\n        diskType: PD_SSD\n        maintenanceWindow:\n          day: 7\n          hour: 3\n        tier: db-custom-8-30720\n- id: sqlReplica\n  template:\n    apiVersion: sql.cnrm.cloud.google.com/v1beta1\n    kind: SQLInstance\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: abandon\n      labels:\n        failure-zone: ${schema.spec.replicaRegion}\n        enabled-service: ${sqlAdminEnable.metadata.name}\n      name: ${schema.spec.name}-replica\n    spec:\n      databaseVersion: POSTGRES_13\n      encryptionKMSCryptoKeyRef:\n        external: projects/${schema.spec.project}/locations/${schema.spec.replicaRegion}/keyRings/${keyringReplica.metadata.name}/cryptoKeys/${kmskeyReplica.metadata.name}\n      masterInstanceRef:\n        name: ${schema.spec.name}-primary\n        #namespace: {{ cloudsqls.metadata.namespace }}\n      region: ${schema.spec.replicaRegion}\n      settings:\n        availabilityType: REGIONAL\n        diskSize: 50\n        diskType: PD_SSD\n        tier: db-custom-8-30720\n'})})]})]})}function d(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(m,{...e})}):m(e)}},28453:(e,n,a)=>{a.d(n,{R:()=>c,x:()=>r});var s=a(96540);const i={},o=s.createContext(i);function c(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:c(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);