"use strict";(self.webpackChunkkro_docs=self.webpackChunkkro_docs||[]).push([[1423],{63076:(e,n,a)=>{a.r(n),a.d(n,{assets:()=>d,contentTitle:()=>l,default:()=>p,frontMatter:()=>c,metadata:()=>r,toc:()=>h});const r=JSON.parse('{"id":"docs/concepts/rgd/resource-definitions/collections","title":"Collections","description":"By default, each resource definition (in spec.resources) creates exactly one","source":"@site/docs/docs/concepts/rgd/02-resource-definitions/04-collections.md","sourceDirName":"docs/concepts/rgd/02-resource-definitions","slug":"/docs/concepts/rgd/resource-definitions/collections","permalink":"/kro/next/docs/concepts/rgd/resource-definitions/collections","draft":false,"unlisted":false,"editUrl":"https://github.com/kubernetes-sigs/kro/tree/main/website/docs/docs/concepts/rgd/02-resource-definitions/04-collections.md","tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4},"sidebar":"docsSidebar","previous":{"title":"Readiness","permalink":"/kro/next/docs/concepts/rgd/resource-definitions/readiness"},"next":{"title":"External References","permalink":"/kro/next/docs/concepts/rgd/resource-definitions/external-references"}}');var s=a(74848),t=a(28453),i=a(11470),o=a(19365);const c={sidebar_position:4},l="Collections",d={},h=[{value:"Basic Example",id:"basic-example",level:2},{value:"forEach Syntax",id:"foreach-syntax",level:2},{value:"Iterating Over Maps",id:"iterating-over-maps",level:3},{value:"Iterator Variables",id:"iterator-variables",level:2},{value:"Resource Naming",id:"resource-naming",level:3},{value:"Multiple Iterators (Cartesian Product)",id:"multiple-iterators-cartesian-product",level:2},{value:"Combination Order",id:"combination-order",level:3},{value:"Collection Sources",id:"collection-sources",level:2},{value:"Referencing Collections",id:"referencing-collections",level:2},{value:"In a Resource",id:"in-a-resource",level:3},{value:"In Another Collection",id:"in-another-collection",level:3},{value:"Dependency Behavior",id:"dependency-behavior",level:3},{value:"Readiness with Collections",id:"readiness-with-collections",level:2},{value:"Conditional Collections",id:"conditional-collections",level:2},{value:"Exposing Collection Data in Instance Status",id:"exposing-collection-data-in-instance-status",level:2},{value:"Collection Lifecycle",id:"collection-lifecycle",level:2},{value:"Scaling Up",id:"scaling-up",level:3},{value:"Scaling Down",id:"scaling-down",level:3},{value:"Empty Collections",id:"empty-collections",level:3},{value:"Drift Detection",id:"drift-detection",level:3},{value:"How Collections Work",id:"how-collections-work",level:2},{value:"Next Steps",id:"next-steps",level:2}];function u(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"collections",children:"Collections"})}),"\n",(0,s.jsxs)(n.p,{children:["By default, each resource definition (in ",(0,s.jsx)(n.code,{children:"spec.resources"}),") creates exactly one\nKubernetes resource. This means the number of resources is fixed at design\ntime - if you need 5 worker Pods, you write 5 resource definitions."]}),"\n",(0,s.jsx)(n.p,{children:"Collections let you declaratively manage multiple similar resources from a\nsingle definition. This is useful when the number of resources depends on\nruntime data like availability zones, tenants, or worker counts."}),"\n",(0,s.jsxs)(n.p,{children:["kro provides the ",(0,s.jsx)(n.code,{children:"forEach"})," field to turn any resource into a collection. The\nfield takes one or more iterators, and kro creates one resource for each element\n(or combination of elements), keeping them in sync as the collection changes."]}),"\n",(0,s.jsx)(n.h2,{id:"basic-example",children:"Basic Example"}),"\n",(0,s.jsxs)(n.p,{children:["This RGD uses ",(0,s.jsx)(n.code,{children:"forEach"})," to create multiple Pods from a single resource entry:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"apiVersion: kro.run/v1alpha1\nkind: ResourceGraphDefinition\nmetadata:\n  name: worker-pool\nspec:\n  schema:\n    apiVersion: v1alpha1\n    kind: WorkerPool\n    spec:\n      workers: \"[]string\"\n      image: string\n\n  resources:\n    - id: workerPods\n      forEach:\n        - worker: ${schema.spec.workers}\n      template:\n        apiVersion: v1\n        kind: Pod\n        metadata:\n          name: ${schema.metadata.name + '-' + worker}\n        spec:\n          containers:\n            - name: app\n              image: ${schema.spec.image}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["When a user creates an instance with ",(0,s.jsx)(n.code,{children:'workers: ["alice", "bob"]'}),", kro creates two\nPods - one for each worker. If the user later updates the list to\n",(0,s.jsx)(n.code,{children:'["alice", "bob", "charlie"]'}),', kro creates a third Pod for "charlie".']}),"\n",(0,s.jsx)(n.h2,{id:"foreach-syntax",children:"forEach Syntax"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"forEach"})," field is an array of iterators. Each iterator is a single-entry\nmap binding a variable name to an expression:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"forEach:\n  - region: ${schema.spec.regions}\n"})}),"\n",(0,s.jsx)(n.p,{children:"Each map entry must have exactly one key-value pair:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Key"}),": The iterator variable name (available in your template expressions)"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Value"}),": A CEL expression that ",(0,s.jsx)(n.strong,{children:"must evaluate to an array"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Arrays maintain their order, so resources are indexed in the same order as\nelements appear in the source array - this ordering is deterministic and\npredictable for naming and labeling purposes."}),"\n",(0,s.jsx)(n.h3,{id:"iterating-over-maps",children:"Iterating Over Maps"}),"\n",(0,s.jsx)(n.p,{children:"If you have map (object) data, convert it to a sorted array first. Maps have\nnon-deterministic iteration order in Go, so converting to a sorted array ensures\nconsistent resource creation order:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:'# Given schema.spec.labels = {"app": "web", "env": "prod", "team": "platform"}\nforEach:\n  # Convert map keys to a sorted array\n  - key: ${schema.spec.labels.map(k, k).sort()}\n'})}),"\n",(0,s.jsx)(n.p,{children:"You can then access the value inside the template using the key."}),"\n",(0,s.jsx)(n.h2,{id:"iterator-variables",children:"Iterator Variables"}),"\n",(0,s.jsx)(n.p,{children:"The variable name you specify becomes available in the template, holding the\ncurrent element:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:'- id: workerPods\n  forEach:\n    - worker: ${schema.spec.workers}  # ["alice", "bob", "charlie"]\n  template:\n    kind: Pod\n    metadata:\n      # <instance-name>-alice, <instance-name>-bob, <instance-name>-charlie\n      name: ${schema.metadata.name + \'-\' + worker}\n'})}),"\n",(0,s.jsx)(n.p,{children:"To access the index, iterate over a range instead:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"- id: workerPods\n  forEach:\n    - idx: ${lists.range(size(schema.spec.workers))}\n  template:\n    kind: Pod\n    metadata:\n      # <instance-name>-0, <instance-name>-1, <instance-name>-2\n      name: ${schema.metadata.name + '-' + string(idx)}\n    spec:\n      containers:\n        - name: worker\n          env:\n            - name: WORKER_NAME\n              value: ${schema.spec.workers[idx]}  # alice, bob, charlie\n"})}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["Use descriptive iterator names that reflect what you're iterating over, like\n",(0,s.jsx)(n.code,{children:"worker"}),", ",(0,s.jsx)(n.code,{children:"region"}),", or ",(0,s.jsx)(n.code,{children:"dbSpec"})," rather than generic names like ",(0,s.jsx)(n.code,{children:"item"})," or ",(0,s.jsx)(n.code,{children:"i"}),"."]})}),"\n",(0,s.jsx)(n.h3,{id:"resource-naming",children:"Resource Naming"}),"\n",(0,s.jsxs)(n.p,{children:["Each resource in a collection must have a unique name. Always include the\niterator variable in ",(0,s.jsx)(n.code,{children:"metadata.name"})," to ensure uniqueness:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"- id: workerPods\n  forEach:\n    - worker: ${schema.spec.workers}\n  template:\n    kind: Pod\n    metadata:\n      # Good: includes iterator variable for uniqueness\n      name: ${schema.metadata.name + '-' + worker}\n"})}),"\n",(0,s.jsxs)(n.admonition,{title:"Unique Names Required",type:"warning",children:[(0,s.jsx)(n.p,{children:"Resource names must be unique not just within the collection, but across all\ninstances and RGDs in the same namespace. Kubernetes identifies resources by\nnamespace + name + kind + apiVersion - if two resources share these, they\nconflict."}),(0,s.jsx)(n.p,{children:"Best practice: always include the instance name to avoid cross-instance\ncollisions:"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:'# With regions: ["us-east", "us-west"] and tiers: ["web", "api"]\nname: ${schema.metadata.name + \'-\' + region + \'-\' + tier}\n# Creates: myapp-us-east-web, myapp-us-east-api, myapp-us-west-web, myapp-us-west-api\n'})}),(0,s.jsxs)(n.p,{children:["If you omit ",(0,s.jsx)(n.code,{children:"schema.metadata.name"}),", two instances with the same iterator values\nwill overwrite each other's resources."]})]}),"\n",(0,s.jsx)(n.h2,{id:"multiple-iterators-cartesian-product",children:"Multiple Iterators (Cartesian Product)"}),"\n",(0,s.jsx)(n.p,{children:"When you specify multiple iterators, kro creates resources for every combination\n(cartesian product) of values:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:'- id: deployments\n  forEach:\n    - region: ${schema.spec.regions}  # ["us-east", "us-west"]\n    - tier: ${schema.spec.tiers}      # ["web", "api"]\n  template:\n    kind: Deployment\n    metadata:\n      # Creates 4 deployments: myapp-us-east-web, myapp-us-east-api, etc.\n      name: ${schema.metadata.name + \'-\' + region + \'-\' + tier}\n    spec:\n      template:\n        spec:\n          containers:\n            - name: app\n              image: ${schema.spec.image}\n              env:\n                - name: REGION\n                  value: ${region}\n                - name: TIER\n                  value: ${tier}\n'})}),"\n",(0,s.jsxs)(n.p,{children:["With ",(0,s.jsx)(n.code,{children:'regions: ["us-east", "us-west"]'})," and ",(0,s.jsx)(n.code,{children:'tiers: ["web", "api"]'}),", this creates\n4 deployments covering all combinations."]}),"\n",(0,s.jsx)(n.h3,{id:"combination-order",children:"Combination Order"}),"\n",(0,s.jsx)(n.p,{children:"The first iterator is the outer loop, subsequent iterators are nested inside.\nResources are created in this order:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# forEach:\n#   - region: ["us-east", "us-west"]\n#   - tier: ["web", "api"]\n\n# Creates resources in order:\n# 1. region=us-east, tier=web\n# 2. region=us-east, tier=api\n# 3. region=us-west, tier=web\n# 4. region=us-west, tier=api\n'})}),"\n",(0,s.jsxs)(n.p,{children:["This order is deterministic as long as each iterator's source array has\ndeterministic order (arrays are ordered, maps are not - see\n",(0,s.jsx)(n.a,{href:"#iterating-over-maps",children:"Iterating Over Maps"})," if you need to iterate over map data)."]}),"\n",(0,s.jsx)(n.admonition,{type:"important",children:(0,s.jsxs)(n.p,{children:["If any iterator's collection is empty, zero resources are created. This follows\nstandard cartesian product behavior: ",(0,s.jsx)(n.code,{children:"2 \xd7 0 = 0"}),"."]})}),"\n",(0,s.jsx)(n.h2,{id:"collection-sources",children:"Collection Sources"}),"\n",(0,s.jsx)(n.p,{children:"The iterator expression must evaluate to an array. Arrays can come from various sources:"}),"\n",(0,s.jsxs)(i.A,{children:[(0,s.jsx)(o.A,{value:"instance-spec",label:"Instance Spec",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"spec:\n  schema:\n    spec:\n      regions: \"[]string\"\n  resources:\n    - id: regionalConfigs\n      forEach:\n        - region: ${schema.spec.regions}\n      template:\n        kind: ConfigMap\n        metadata:\n          name: ${schema.metadata.name + '-config-' + region}\n"})})}),(0,s.jsx)(o.A,{value:"resource-spec",label:"Resource Spec",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"resources:\n  - id: database\n    template:\n      apiVersion: db.example.com/v1\n      kind: Database\n      metadata:\n        name: ${schema.metadata.name + '-db'}\n      spec:\n        shards:\n          - name: users\n            region: us-east\n          - name: orders\n            region: us-west\n\n  - id: shardBackups\n    forEach:\n      - shard: ${database.spec.shards}\n    template:\n      kind: CronJob\n      metadata:\n        name: ${schema.metadata.name + '-backup-' + shard.name}\n      spec:\n        schedule: \"0 2 * * *\"\n        # ...\n"})})}),(0,s.jsx)(o.A,{value:"resource-status",label:"Resource Status",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"resources:\n  - id: cluster\n    template:\n      apiVersion: kafka.example.com/v1\n      kind: KafkaCluster\n      metadata:\n        name: ${schema.metadata.name + '-kafka'}\n      spec:\n        brokers: 3\n\n  - id: brokerServices\n    forEach:\n      - broker: ${cluster.status.brokers}\n    template:\n      kind: Service\n      metadata:\n        name: ${schema.metadata.name + '-broker-' + string(broker.id)}\n      spec:\n        type: ExternalName\n        externalName: ${broker.host}\n"})})}),(0,s.jsx)(o.A,{value:"array",label:"Array Literal",children:(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:'resources:\n  - id: zoneConfigs\n    forEach:\n      - zone: ${["us-east-1a", "us-east-1b", "us-east-1c"]}\n    template:\n      kind: ConfigMap\n      metadata:\n        name: ${schema.metadata.name + \'-config-\' + zone}\n\n  - id: shards\n    forEach:\n      - shardNum: ${lists.range(3)}  # CEL function that returns [0, 1, 2]\n    template:\n      kind: StatefulSet\n      metadata:\n        name: ${schema.metadata.name + \'-shard-\' + string(shardNum)}\n'})})})]}),"\n",(0,s.jsx)(n.h2,{id:"referencing-collections",children:"Referencing Collections"}),"\n",(0,s.jsxs)(n.p,{children:["Other resources can reference a collection by its ID. The collection exposes\nall created resources as an array, which you can use with CEL functions like\n",(0,s.jsx)(n.code,{children:"map()"}),", ",(0,s.jsx)(n.code,{children:"filter()"}),", and ",(0,s.jsx)(n.code,{children:"all()"}),"."]}),"\n",(0,s.jsx)(n.h3,{id:"in-a-resource",children:"In a Resource"}),"\n",(0,s.jsx)(n.p,{children:"Use CEL functions to aggregate collection data into a single resource:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"- id: workerPods\n  forEach:\n    - worker: ${schema.spec.workers}\n  template:\n    kind: Pod\n    metadata:\n      name: ${schema.metadata.name + '-' + worker}\n    # ...\n\n- id: summary\n  template:\n    kind: ConfigMap\n    metadata:\n      name: ${schema.metadata.name + '-summary'}\n    data:\n      podNames: ${workerPods.map(p, p.metadata.name).join(', ')}\n      count: ${string(size(workerPods))}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"in-another-collection",children:"In Another Collection"}),"\n",(0,s.jsx)(n.p,{children:"One collection can iterate over another to create dependent resources:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"- id: databases\n  forEach:\n    - dbSpec: ${schema.spec.databases}\n  template:\n    apiVersion: db.example.com/v1\n    kind: Database\n    metadata:\n      name: ${schema.metadata.name + '-' + dbSpec.name}\n    spec:\n      storage: ${dbSpec.storage}\n\n- id: backupJobs\n  forEach:\n    - db: ${databases}  # iterate over the collection\n  template:\n    kind: CronJob\n    metadata:\n      name: ${schema.metadata.name + '-backup-' + db.metadata.name}\n    spec:\n      schedule: \"0 2 * * *\"\n      jobTemplate:\n        spec:\n          template:\n            spec:\n              containers:\n                - name: backup\n                  env:\n                    - name: DB_HOST\n                      value: ${db.status.endpoint}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"dependency-behavior",children:"Dependency Behavior"}),"\n",(0,s.jsxs)(n.p,{children:["Like references in templates, resource references in ",(0,s.jsx)(n.code,{children:"forEach"})," expressions\ncreate edges in the dependency graph. Any reference between a resource and a\ncollection - whether in the ",(0,s.jsx)(n.code,{children:"forEach"})," expression or in the template - causes\nkro to wait for the referenced collection to be fully reconciled and ready\n(",(0,s.jsx)(n.code,{children:"readyWhen"})," resolves to true) before proceeding:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"resources:\n  # Collection A: creates multiple databases\n  - id: databases\n    forEach:\n      - dbSpec: ${schema.spec.databases}\n    template:\n      kind: Database\n      metadata:\n        name: ${schema.metadata.name + '-' + dbSpec.name}\n      # ...\n\n  # Collection B: depends on Collection A\n  # kro waits for ALL databases to be ready before creating backup jobs\n  - id: backupJobs\n    forEach:\n      - db: ${databases}\n    template:\n      kind: CronJob\n      metadata:\n        name: ${schema.metadata.name + '-backup-' + db.metadata.name}\n      # ...\n\n  # Resource C: depends on Collection B\n  # kro waits for ALL backup jobs to be ready before creating the summary\n  - id: summary\n    template:\n      kind: ConfigMap\n      metadata:\n        name: ${schema.metadata.name + '-summary'}\n      data:\n        backupCount: ${string(size(backupJobs))}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"readiness-with-collections",children:"Readiness with Collections"}),"\n",(0,s.jsxs)(n.p,{children:["For collections, ",(0,s.jsx)(n.code,{children:"readyWhen"})," uses the ",(0,s.jsx)(n.code,{children:"each"})," keyword for per-item readiness\nchecks. The collection is ready when ",(0,s.jsx)(n.strong,{children:"all"})," items pass ",(0,s.jsx)(n.strong,{children:"all"})," readyWhen\nexpressions (AND semantics):"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"- id: workerPods\n  forEach:\n    - worker: ${schema.spec.workers}\n  readyWhen:\n    - ${each.status.phase == 'Running'}  # Per-item check using `each`\n  template:\n    kind: Pod\n    metadata:\n      name: ${schema.metadata.name + '-' + worker}\n    spec:\n      containers:\n        - name: app\n          image: ${schema.spec.image}\n"})}),"\n",(0,s.jsxs)(n.p,{children:["In this example, ",(0,s.jsx)(n.code,{children:"workerPods"})," is only considered ready when ",(0,s.jsx)(n.strong,{children:"every"})," pod in the\ncollection has ",(0,s.jsx)(n.code,{children:"status.phase == 'Running'"}),". Dependent resources wait for this\ncondition before proceeding."]}),"\n",(0,s.jsx)(n.admonition,{type:"tip",children:(0,s.jsxs)(n.p,{children:["Without ",(0,s.jsx)(n.code,{children:"readyWhen"}),", a collection is considered ready once all resources are\ncreated. Add ",(0,s.jsx)(n.code,{children:"readyWhen"})," when dependent resources need specific conditions to be\ntrue, not just existence."]})}),"\n",(0,s.jsx)(n.h2,{id:"conditional-collections",children:"Conditional Collections"}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"includeWhen"})," field operates on the collection as a whole. If the condition\nevaluates to ",(0,s.jsx)(n.code,{children:"false"}),", the entire collection is skipped - no resources are\ncreated. You cannot use ",(0,s.jsx)(n.code,{children:"includeWhen"})," to exclude individual items:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"- id: backupJobs\n  includeWhen:\n    - ${schema.spec.backupsEnabled}  # all or nothing\n  forEach:\n    - dbSpec: ${schema.spec.databases}\n  template:\n    kind: CronJob\n    metadata:\n      name: ${schema.metadata.name + '-backup-' + dbSpec.name}\n    # ...\n"})}),"\n",(0,s.jsxs)(n.p,{children:["To filter individual items from a collection, use ",(0,s.jsx)(n.code,{children:"filter()"})," in the ",(0,s.jsx)(n.code,{children:"forEach"}),"\nexpression:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"- id: backupJobs\n  forEach:\n    # Only iterate over databases that have backups enabled\n    - dbSpec: ${schema.spec.databases.filter(d, d.backupEnabled)}\n  template:\n    kind: CronJob\n    metadata:\n      name: ${schema.metadata.name + '-backup-' + dbSpec.name}\n    # ...\n"})}),"\n",(0,s.jsx)(n.h2,{id:"exposing-collection-data-in-instance-status",children:"Exposing Collection Data in Instance Status"}),"\n",(0,s.jsx)(n.p,{children:"Status expressions can reference collections to compute aggregate values. This\nlets you expose summary information about the collection in your custom\nresource's status:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-kro",children:"spec:\n  schema:\n    apiVersion: v1alpha1\n    kind: WorkerPool\n    spec:\n      workers: \"[]string\"\n    status:\n      total: ${size(workerPods)}\n      running: ${size(workerPods.filter(w, w.status.phase == 'Running'))}\n      ready: ${workerPods.all(w, w.status.phase == 'Running')}\n\n  resources:\n    - id: workerPods\n      forEach:\n        - worker: ${schema.spec.workers}\n      template:\n        kind: Pod\n        metadata:\n          name: ${schema.metadata.name + '-' + worker}\n        # ...\n"})}),"\n",(0,s.jsx)(n.h2,{id:"collection-lifecycle",children:"Collection Lifecycle"}),"\n",(0,s.jsx)(n.p,{children:"Collections automatically stay in sync with their source data. When the source\narray changes, kro creates, updates, or deletes resources to match."}),"\n",(0,s.jsx)(n.h3,{id:"scaling-up",children:"Scaling Up"}),"\n",(0,s.jsx)(n.p,{children:"When items are added to the source array, kro creates new resources:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# Instance spec change:\n# workers: ["alice", "bob"] \u2192 ["alice", "bob", "charlie"]\n#\n# Result: kro creates a new pod for "charlie"\n'})}),"\n",(0,s.jsx)(n.h3,{id:"scaling-down",children:"Scaling Down"}),"\n",(0,s.jsx)(n.p,{children:"When items are removed from the source array, kro automatically deletes the\ncorresponding resources:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# Instance spec change:\n# workers: ["alice", "bob", "charlie"] \u2192 ["alice"]\n#\n# Result: kro deletes pods for "bob" and "charlie"\n'})}),"\n",(0,s.jsx)(n.p,{children:"This cleanup happens automatically through kro's applyset mechanism - orphaned\nresources are pruned on each reconciliation."}),"\n",(0,s.jsx)(n.h3,{id:"empty-collections",children:"Empty Collections"}),"\n",(0,s.jsx)(n.p,{children:"An empty array results in zero resources - this is not an error:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"# workers: []\n# Result: zero pods created (collection exists but is empty)\n"})}),"\n",(0,s.jsx)(n.p,{children:"This is useful for optional features that can be enabled by adding items to an\ninitially empty array."}),"\n",(0,s.jsx)(n.admonition,{type:"important",children:(0,s.jsxs)(n.p,{children:["If any iterator in a cartesian product is empty, zero resources are created.\nFor example, ",(0,s.jsx)(n.code,{children:'regions: ["us-east"]'})," \xd7 ",(0,s.jsx)(n.code,{children:"tiers: []"})," = zero deployments."]})}),"\n",(0,s.jsx)(n.h3,{id:"drift-detection",children:"Drift Detection"}),"\n",(0,s.jsx)(n.p,{children:"kro continuously reconciles collection resources to match the desired state. If\na resource is modified externally (drift), kro restores it:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'# 1. kro creates ConfigMap with data.prefix: "original"\n# 2. Someone manually changes data.prefix to "MODIFIED"\n# 3. kro detects the drift and restores data.prefix to "original"\n'})}),"\n",(0,s.jsx)(n.p,{children:"This applies to all fields that kro manages. Fields added by other controllers\n(not in kro's template) are preserved."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"how-collections-work",children:"How Collections Work"}),"\n",(0,s.jsx)(n.p,{children:"This section explains the internal mechanics for those who want to understand\nwhat happens under the hood. You don't need this to use collections effectively."}),"\n",(0,s.jsxs)(n.p,{children:["When you add ",(0,s.jsx)(n.code,{children:"forEach"})," to a resource, kro treats that resource block as a\ntemplate for multiple resources rather than a single one."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"At RGD validation time (static analysis)"}),", kro analyzes the ",(0,s.jsx)(n.code,{children:"forEach"}),"\nexpressions to determine the element types. If ",(0,s.jsx)(n.code,{children:"schema.spec.workers"})," is\n",(0,s.jsx)(n.code,{children:"[]string"}),", kro knows each iteration yields a string and types the iterator\nvariable accordingly. This enables ",(0,s.jsx)(n.a,{href:"/kro/next/docs/concepts/rgd/static-type-checking",children:"static type checking"}),"\nof expressions inside the template before any resources are created."]}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"At instance reconciliation time (runtime)"}),", when the reconciler reaches a\ncollection node in the dependency graph:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Evaluates each forEach CEL expression to get the current collections"}),"\n",(0,s.jsx)(n.li,{children:"Creates multiple resources - one per element (or combination)"}),"\n",(0,s.jsx)(n.li,{children:"Compares against existing resources and creates, updates, or deletes as\nneeded"}),"\n",(0,s.jsxs)(n.li,{children:["Evaluates ",(0,s.jsx)(n.code,{children:"readyWhen"})," (if specified) across all collection resources before\nproceeding to dependent nodes"]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Each resource in the collection is tracked independently. If one resource fails\nto reconcile, the others continue - kro doesn't require all-or-nothing success\nwithin a collection."}),"\n",(0,s.jsx)(n.admonition,{type:"note",children:(0,s.jsxs)(n.p,{children:["In kro, each entry in ",(0,s.jsx)(n.code,{children:"spec.resources"})," is a node in the dependency graph. A\ncollection (a resource with ",(0,s.jsx)(n.code,{children:"forEach"}),") is also a single node in the graph - it\ncreates multiple resources at runtime, but dependencies treat it as one unit."]})}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"/kro/next/docs/concepts/rgd/resource-definitions/external-references",children:"External References"})})," - Reference existing\nresources not managed by kro"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"/kro/next/docs/concepts/rgd/cel-expressions",children:"CEL Expressions"})})," - Learn about CEL functions\nlike ",(0,s.jsx)(n.code,{children:"lists.range()"}),", ",(0,s.jsx)(n.code,{children:"filter()"}),", and ",(0,s.jsx)(n.code,{children:"map()"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:(0,s.jsx)(n.a,{href:"/kro/next/docs/concepts/rgd/dependencies-ordering",children:"Dependencies & Ordering"})})," - Understand\nhow collections affect the dependency graph"]}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},19365:(e,n,a)=>{a.d(n,{A:()=>i});a(96540);var r=a(34164);const s={tabItem:"tabItem_Ymn6"};var t=a(74848);function i({children:e,hidden:n,className:a}){return(0,t.jsx)("div",{role:"tabpanel",className:(0,r.A)(s.tabItem,a),hidden:n,children:e})}},11470:(e,n,a)=>{a.d(n,{A:()=>w});var r=a(96540),s=a(34164),t=a(17559),i=a(23104),o=a(56347),c=a(205),l=a(57485),d=a(31682),h=a(70679);function u(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:n}=e;return!!n&&"object"==typeof n&&"value"in n}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function p(e){const{values:n,children:a}=e;return(0,r.useMemo)((()=>{const e=n??function(e){return u(e).map((({props:{value:e,label:n,attributes:a,default:r}})=>({value:e,label:n,attributes:a,default:r})))}(a);return function(e){const n=(0,d.XI)(e,((e,n)=>e.value===n.value));if(n.length>0)throw new Error(`Docusaurus error: Duplicate values "${n.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[n,a])}function m({value:e,tabValues:n}){return n.some((n=>n.value===e))}function x({queryString:e=!1,groupId:n}){const a=(0,o.W6)(),s=function({queryString:e=!1,groupId:n}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:e,groupId:n});return[(0,l.aZ)(s),(0,r.useCallback)((e=>{if(!s)return;const n=new URLSearchParams(a.location.search);n.set(s,e),a.replace({...a.location,search:n.toString()})}),[s,a])]}function f(e){const{defaultValue:n,queryString:a=!1,groupId:s}=e,t=p(e),[i,o]=(0,r.useState)((()=>function({defaultValue:e,tabValues:n}){if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!m({value:e,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}const a=n.find((e=>e.default))??n[0];if(!a)throw new Error("Unexpected error: 0 tabValues");return a.value}({defaultValue:n,tabValues:t}))),[l,d]=x({queryString:a,groupId:s}),[u,f]=function({groupId:e}){const n=function(e){return e?`docusaurus.tab.${e}`:null}(e),[a,s]=(0,h.Dv)(n);return[a,(0,r.useCallback)((e=>{n&&s.set(e)}),[n,s])]}({groupId:s}),g=(()=>{const e=l??u;return m({value:e,tabValues:t})?e:null})();(0,c.A)((()=>{g&&o(g)}),[g]);return{selectedValue:i,selectValue:(0,r.useCallback)((e=>{if(!m({value:e,tabValues:t}))throw new Error(`Can't select invalid tab value=${e}`);o(e),d(e),f(e)}),[d,f,t]),tabValues:t}}var g=a(92303);const b={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var j=a(74848);function k({className:e,block:n,selectedValue:a,selectValue:r,tabValues:t}){const o=[],{blockElementScrollPositionUntilNextRender:c}=(0,i.a_)(),l=e=>{const n=e.currentTarget,s=o.indexOf(n),i=t[s].value;i!==a&&(c(n),r(i))},d=e=>{let n=null;switch(e.key){case"Enter":l(e);break;case"ArrowRight":{const a=o.indexOf(e.currentTarget)+1;n=o[a]??o[0];break}case"ArrowLeft":{const a=o.indexOf(e.currentTarget)-1;n=o[a]??o[o.length-1];break}}n?.focus()};return(0,j.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,s.A)("tabs",{"tabs--block":n},e),children:t.map((({value:e,label:n,attributes:r})=>(0,j.jsx)("li",{role:"tab",tabIndex:a===e?0:-1,"aria-selected":a===e,ref:e=>{o.push(e)},onKeyDown:d,onClick:l,...r,className:(0,s.A)("tabs__item",b.tabItem,r?.className,{"tabs__item--active":a===e}),children:n??e},e)))})}function y({lazy:e,children:n,selectedValue:a}){const t=(Array.isArray(n)?n:[n]).filter(Boolean);if(e){const e=t.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:(0,s.A)("margin-top--md",e.props.className)}):null}return(0,j.jsx)("div",{className:"margin-top--md",children:t.map(((e,n)=>(0,r.cloneElement)(e,{key:n,hidden:e.props.value!==a})))})}function v(e){const n=f(e);return(0,j.jsxs)("div",{className:(0,s.A)(t.G.tabs.container,"tabs-container",b.tabList),children:[(0,j.jsx)(k,{...n,...e}),(0,j.jsx)(y,{...n,...e})]})}function w(e){const n=(0,g.A)();return(0,j.jsx)(v,{...e,children:u(e.children)},String(n))}},28453:(e,n,a)=>{a.d(n,{R:()=>i,x:()=>o});var r=a(96540);const s={},t=r.createContext(s);function i(e){const n=r.useContext(t);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);