"use strict";(self.webpackChunkkro_docs=self.webpackChunkkro_docs||[]).push([[9433],{55010:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>i,default:()=>u,frontMatter:()=>a,metadata:()=>o,toc:()=>l});const o=JSON.parse('{"id":"examples/gcp/gke-cluster","title":"GKECluster","description":"A Platform Administrator wants to give end users in their organization self-service access to create GKE clusters. The platform administrator creates a kro ResourceGraphDefinition called gkecluster.kro.run that defines the required Kubernetes resources and a CRD called GKEcluster that exposes only the options they want to be configurable by end users. The ResourceGraphDefinition would define the following resources (using KCC to provide the mappings from K8s CRDs to Google Cloud APIs):","source":"@site/versioned_docs/version-0.6.3/examples/gcp/gke-cluster.md","sourceDirName":"examples/gcp","slug":"/examples/gcp/gke-cluster","permalink":"/examples/gcp/gke-cluster","draft":false,"unlisted":false,"editUrl":"https://github.com/kubernetes-sigs/kro/tree/main/website/versioned_docs/version-0.6.3/examples/gcp/gke-cluster.md","tags":[],"version":"0.6.3","sidebarPosition":405,"frontMatter":{"sidebar_position":405},"sidebar":"examplesSidebar","previous":{"title":"Optional Values & External References","permalink":"/examples/basic/optionals"},"next":{"title":"CloudSQL","permalink":"/examples/gcp/cloud-sql"}}');var s=t(74848),r=t(28453);const a={sidebar_position:405},i="GKECluster",c={},l=[{value:"End User: GKECluster",id:"end-user-gkecluster",level:2},{value:"Administrator: ResourceGraphDefinition",id:"administrator-resourcegraphdefinition",level:2}];function d(e){const n={a:"a",code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components},{Details:o}=n;return o||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"gkecluster",children:"GKECluster"})}),"\n",(0,s.jsxs)(n.p,{children:["A ",(0,s.jsx)(n.strong,{children:"Platform Administrator"})," wants to give end users in their organization self-service access to create GKE clusters. The platform administrator creates a kro ResourceGraphDefinition called ",(0,s.jsx)(n.em,{children:"gkecluster.kro.run"})," that defines the required Kubernetes resources and a CRD called ",(0,s.jsx)(n.em,{children:"GKEcluster"})," that exposes only the options they want to be configurable by end users. The ResourceGraphDefinition would define the following resources (using ",(0,s.jsx)(n.a,{href:"https://github.com/GoogleCloudPlatform/k8s-config-connector",children:"KCC"})," to provide the mappings from K8s CRDs to Google Cloud APIs):"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"GKE cluster"}),"\n",(0,s.jsx)(n.li,{children:"Container Node Pool"}),"\n",(0,s.jsx)(n.li,{children:"Network"}),"\n",(0,s.jsx)(n.li,{children:"Subnetwork"}),"\n",(0,s.jsx)(n.li,{children:"KMSKeyRing   - Encrypt BootDisk"}),"\n",(0,s.jsx)(n.li,{children:"KMSCryptoKey - Encrypt BootDisk"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Everything related to these resources would be hidden from the end user, simplifying their experience."}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.img,{alt:"GKE Cluster Stack",src:t(96344).A+"",width:"1803",height:"938"})}),"\n",(0,s.jsx)(n.h2,{id:"end-user-gkecluster",children:"End User: GKECluster"}),"\n",(0,s.jsxs)(n.p,{children:["The administrator needs to install the RGD first.\nThe end user creates a ",(0,s.jsx)(n.code,{children:"GKECluster"})," resource something like this:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: kro.run/v1alpha1\nkind: GKECluster\nmetadata:\n  name: krodemo\n  namespace: config-connector\nspec:\n  name: krodemo         # Name used for all resources created as part of this RGD\n  location: us-central1 # Region where the GCP resources are created\n  maxnodes: 4           # Max scaling limit for the nodes in the new nodepool\n"})}),"\n",(0,s.jsx)(n.p,{children:"They can then check the status of the applied resource:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl get gkeclusters\nkubectl get gkeclusters krodemo -n config-connector -o yaml\n"})}),"\n",(0,s.jsx)(n.p,{children:"Navigate to GKE Cluster page in the GCP Console and verify the cluster creation."}),"\n",(0,s.jsxs)(n.p,{children:["Once done, the user can delete the ",(0,s.jsx)(n.code,{children:"GKECluster"})," instance:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl delete gkecluster krodemo -n config-connector\n"})}),"\n",(0,s.jsx)(n.h2,{id:"administrator-resourcegraphdefinition",children:"Administrator: ResourceGraphDefinition"}),"\n",(0,s.jsx)(n.p,{children:"The administrator needs to install the RGD in the cluster first before the user can consume it:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl apply -f rgd.yaml\n"})}),"\n",(0,s.jsx)(n.p,{children:"Validate the RGD is installed correctly:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"kubectl get rgd gkecluster.kro.run\n"})}),"\n",(0,s.jsx)(n.p,{children:"Once all user created instances are deleted, the administrator can choose to deleted the RGD."}),"\n",(0,s.jsxs)(o,{children:[(0,s.jsx)("summary",{children:"ResourceGraphDefinition"}),(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:'title="rgd.yaml"',children:'apiVersion: kro.run/v1alpha1\nkind: ResourceGraphDefinition\nmetadata:\nname: gkecluster.kro.run\nspec:\nschema:\n  apiVersion: v1alpha1\n  kind: GKECluster\n  spec:\n    name: string\n    nodepool: string\n    maxnodes: integer\n    location: string\n  status:\n    masterVersion: ${cluster.status.masterVersion}\nresources:\n- id: network\n  template:\n    apiVersion: compute.cnrm.cloud.google.com/v1beta1\n    kind: ComputeNetwork\n    metadata:\n      labels:\n        source: "gkecluster"\n      name: ${schema.spec.name}\n    spec:\n      #routingMode: GLOBAL\n      #deleteDefaultRoutesOnCreate: false\n      routingMode: REGIONAL\n      autoCreateSubnetworks: false\n- id: subnet\n  template:\n    apiVersion: compute.cnrm.cloud.google.com/v1beta1\n    kind: ComputeSubnetwork\n    metadata:\n      labels:\n        source: "gkecluster"\n      name: ${network.metadata.name}\n    spec:\n      ipCidrRange: 10.2.0.0/16\n      #ipCidrRange: 10.10.90.0/24\n      region: ${schema.spec.location}\n      networkRef:\n        name: ${schema.spec.name}\n      #privateIpGoogleAccess: true\n- id: topic\n  template:\n    apiVersion: pubsub.cnrm.cloud.google.com/v1beta1\n    kind: PubSubTopic\n    metadata:\n      labels:\n        source: "gkecluster"\n      name: ${subnet.metadata.name}\n- id: keyring\n  template:\n    apiVersion: kms.cnrm.cloud.google.com/v1beta1\n    kind: KMSKeyRing\n    metadata:\n      labels:\n        source: "gkecluster"\n      name: ${topic.metadata.name}\n    spec:\n      location: ${schema.spec.location}\n- id: key\n  template:\n    apiVersion: kms.cnrm.cloud.google.com/v1beta1\n    kind: KMSCryptoKey\n    metadata:\n      labels:\n        source: "gkecluster"\n      name: ${keyring.metadata.name}\n    spec:\n      keyRingRef:\n        name: ${schema.spec.name}\n      purpose: ASYMMETRIC_SIGN\n      versionTemplate:\n        algorithm: EC_SIGN_P384_SHA384\n        protectionLevel: SOFTWARE\n      importOnly: false\n- id: nodepool\n  template:\n    apiVersion: container.cnrm.cloud.google.com/v1beta1\n    kind: ContainerNodePool\n    metadata:\n      labels:\n        source: "gkecluster"\n      name: ${cluster.metadata.name}\n    spec:\n      location: ${schema.spec.location}\n      autoscaling:\n        minNodeCount: 1\n        maxNodeCount: ${schema.spec.maxnodes}\n      nodeConfig:\n        machineType: n1-standard-1\n        diskSizeGb: 100\n        diskType: pd-standard\n        #taint:\n        #- effect: NO_SCHEDULE\n        #  key: originalKey\n        #  value: originalValue\n      clusterRef:\n        name: ${schema.spec.name}\n- id: cluster\n  template:\n    apiVersion: container.cnrm.cloud.google.com/v1beta1\n    kind: ContainerCluster\n    metadata:\n      #annotations:\n      #  cnrm.cloud.google.com/remove-default-node-pool: "false"\n      labels:\n        source: "gkecluster"\n      name: ${key.metadata.name}\n    spec:\n      location: ${schema.spec.location}\n      initialNodeCount: 1\n      networkRef:\n        name: ${schema.spec.name}\n      subnetworkRef:\n        name: ${schema.spec.name}\n      ipAllocationPolicy:\n        clusterIpv4CidrBlock: /20\n        servicesIpv4CidrBlock: /20\n      #masterAuth:\n      #  clientCertificateConfig:\n      #    issueClientCertificate: false\n      #workloadIdentityConfig:\n      #  # Workload Identity supports only a single namespace based on your project name.\n      #  # Replace ${PROJECT_ID?} below with your project ID.\n      #  workloadPool: ${PROJECT_ID?}.svc.id.goog      \n      notificationConfig:\n        pubsub:\n          enabled: true\n          topicRef:\n            name: ${schema.spec.name}\n      loggingConfig:\n        enableComponents:\n          - "SYSTEM_COMPONENTS"\n          - "WORKLOADS"\n      monitoringConfig:\n        enableComponents:\n          - "SYSTEM_COMPONENTS"\n          - "APISERVER"\n        managedPrometheus:\n          enabled: true\n      clusterAutoscaling:\n        enabled: true\n        autoscalingProfile: BALANCED\n        resourceLimits:\n          - resourceType: cpu\n            maximum: 100\n            minimum: 10\n          - resourceType: memory\n            maximum: 1000\n            minimum: 100\n        autoProvisioningDefaults:\n          bootDiskKMSKeyRef:\n            name: ${schema.spec.name}\n      nodeConfig:\n        linuxNodeConfig:\n          sysctls:\n            net.core.somaxconn: "4096"\n          cgroupMode: "CGROUP_MODE_UNSPECIFIED"\n    \n'})})]})]})}function u(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},96344:(e,n,t)=>{t.d(n,{A:()=>o});const o=t.p+"assets/images/gke-cluster-8f32620e5bceba2db541a4b14f0b8ff0.png"},28453:(e,n,t)=>{t.d(n,{R:()=>a,x:()=>i});var o=t(96540);const s={},r=o.createContext(s);function a(e){const n=o.useContext(r);return o.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),o.createElement(r.Provider,{value:n},e.children)}}}]);