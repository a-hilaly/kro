"use strict";(self.webpackChunkkro_docs=self.webpackChunkkro_docs||[]).push([[4056],{69033:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>m,frontMatter:()=>c,metadata:()=>a,toc:()=>l});const a=JSON.parse('{"id":"examples/gcp/eventarc","title":"GCSBucketWithFinalizerTrigger","description":"A Platform Administrator wants to give end users in their organization self-service access to creating GCS Buckets that triggers a Cloud Workflow when any object in it is finalized. The platform administrator creates a kro ResourceGraphDefinition called gcsbucketwithfinalizertrigger.kro.run that defines the required Kubernetes resources and a CRD called GCSBucketWithFinalizertrigger that exposes only the options they want to be configurable by end users.","source":"@site/versioned_docs/version-0.7.0/examples/gcp/eventarc.md","sourceDirName":"examples/gcp","slug":"/examples/gcp/eventarc","permalink":"/kro/examples/gcp/eventarc","draft":false,"unlisted":false,"editUrl":"https://github.com/kubernetes-sigs/kro/tree/main/website/versioned_docs/version-0.7.0/examples/gcp/eventarc.md","tags":[],"version":"0.7.0","sidebarPosition":407,"frontMatter":{"sidebar_position":407},"sidebar":"examplesSidebar","previous":{"title":"CloudSQL","permalink":"/kro/examples/gcp/cloud-sql"},"next":{"title":"CoreDNS Deployment","permalink":"/kro/examples/kubernetes/deploying-coredns"}}');var r=t(74848),i=t(28453);const c={sidebar_position:407},o="GCSBucketWithFinalizerTrigger",s={},l=[{value:"End User: GCSBucketWithFinalizerTrigger",id:"end-user-gcsbucketwithfinalizertrigger",level:2},{value:"Administrator: ResourceGraphDefinition",id:"administrator-resourcegraphdefinition",level:2}];function d(e){const n={code:"code",em:"em",h1:"h1",h2:"h2",header:"header",img:"img",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components},{Details:a}=n;return a||function(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}("Details",!0),(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"gcsbucketwithfinalizertrigger",children:"GCSBucketWithFinalizerTrigger"})}),"\n",(0,r.jsxs)(n.p,{children:["A ",(0,r.jsx)(n.strong,{children:"Platform Administrator"})," wants to give end users in their organization self-service access to creating GCS Buckets that triggers a Cloud Workflow when any object in it is finalized. The platform administrator creates a kro ResourceGraphDefinition called ",(0,r.jsx)(n.em,{children:"gcsbucketwithfinalizertrigger.kro.run"})," that defines the required Kubernetes resources and a CRD called ",(0,r.jsx)(n.em,{children:"GCSBucketWithFinalizertrigger"})," that exposes only the options they want to be configurable by end users."]}),"\n",(0,r.jsx)(n.p,{children:"The following KCC objects are created by this RGD:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"IAMServiceAccount, IAMPolicyMember: Service Account with necessary permissions for Eventarc and Pub/Sub."}),"\n",(0,r.jsx)(n.li,{children:"StorageBucket"}),"\n",(0,r.jsx)(n.li,{children:"PubSubTopic"}),"\n",(0,r.jsx)(n.li,{children:"EventArcTrigger"}),"\n",(0,r.jsx)(n.li,{children:"StorageNotification: To publish events from the GCS bucket to a Pub/Sub topic."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Pre-requisites:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:"Workflow: The workflow to be triggered on Finalizer event."}),"\n"]}),"\n",(0,r.jsx)(n.p,{children:"Everything related to these resources would be hidden from the end user, simplifying their experience."}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.img,{alt:"GCS EventArc Stack",src:t(52502).A+"",width:"1106",height:"480"})}),"\n",(0,r.jsx)(n.h2,{id:"end-user-gcsbucketwithfinalizertrigger",children:"End User: GCSBucketWithFinalizerTrigger"}),"\n",(0,r.jsxs)(n.p,{children:["The administrator needs to install the RGD first.\nThe end user creates a ",(0,r.jsx)(n.code,{children:"GCSBucketWithFinalizerTrigger"})," resource something like this:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: kro.run/v1alpha1\nkind: GCSBucketWithFinalizerTrigger\nmetadata:\n  name: gcsevent-test\n  namespace: config-connector\nspec:\n  name: demo-gcs               # used as name or prefix for KCC objects\n  workflowName: gcs-finalizer-workflow   # Replace with your workflow path\n  location: us-central1        # desired location\n  project: my-project-name     # Replace with your project name\n"})}),"\n",(0,r.jsx)(n.p,{children:"They can then check the status of the applied resource:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"kubectl get gcsbucketwithfinalizertrigger -n config-connector\nkubectl get gcsbucketwithfinalizertrigger gcsevent-test -n config-connector -o yaml\n"})}),"\n",(0,r.jsx)(n.p,{children:"Navigate to GCS page in the GCP Console and verify the bucket creation. Also verify that the Triggers are setup correctly in the EventArc page."}),"\n",(0,r.jsxs)(n.p,{children:["Once done, the user can delete the ",(0,r.jsx)(n.code,{children:"GCSBucketWithFinalizerTrigger"})," instance:"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"kubectl delete gcsbucketwithfinalizertrigger gcsevent-test -n config-connector\n"})}),"\n",(0,r.jsx)(n.h2,{id:"administrator-resourcegraphdefinition",children:"Administrator: ResourceGraphDefinition"}),"\n",(0,r.jsx)(n.p,{children:"The administrator needs to install the RGD in the cluster first before the user can consume it:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"kubectl apply -f rgd.yaml\n"})}),"\n",(0,r.jsx)(n.p,{children:"Validate the RGD is installed correctly:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"kubectl get rgd gcsbucketwithfinalizertrigger.kro.run\n"})}),"\n",(0,r.jsx)(n.p,{children:"Once all user created instances are deleted, the administrator can choose to deleted the RGD."}),"\n",(0,r.jsxs)(a,{children:[(0,r.jsx)("summary",{children:"ResourceGraphDefinition"}),(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title="rgd.yaml"',children:'apiVersion: kro.run/v1alpha1\nkind: ResourceGraphDefinition\nmetadata:\nname: gcsbucketwithfinalizertrigger.kro.run\nspec:\nschema:\n  apiVersion: v1alpha1\n  kind: GCSBucketWithFinalizerTrigger\n  spec:\n    name: string\n    workflowName: string\n    location: string\n    project: string\n  status:\n    url: ${bucket.status.url}\nresources:\n- id: storageEnable\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: Service\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: "abandon"\n        cnrm.cloud.google.com/disable-dependent-services: "false"\n      name: storage-enablement\n    spec:\n      resourceID: storage.googleapis.com\n- id: iamEnable\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: Service\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: "abandon"\n        cnrm.cloud.google.com/disable-dependent-services: "false"\n      name: iam-enablement\n    spec:\n      resourceID: iam.googleapis.com\n- id: pubsubEnable\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: Service\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: "abandon"\n        cnrm.cloud.google.com/disable-dependent-services: "false"\n      name: pubsub-enablement\n    spec:\n      resourceID: pubsub.googleapis.com\n- id: eventarcEnable\n  template:\n    apiVersion: serviceusage.cnrm.cloud.google.com/v1beta1\n    kind: Service\n    metadata:\n      annotations:\n        cnrm.cloud.google.com/deletion-policy: "abandon"\n        cnrm.cloud.google.com/disable-dependent-services: "false"\n      name: eventarc-enablement\n    spec:\n      resourceID: eventarc.googleapis.com\n- id: iamsa\n  template:\n    apiVersion: iam.cnrm.cloud.google.com/v1beta1\n    kind: IAMServiceAccount\n    metadata:\n      labels:\n        enabled-service: ${iamEnable.metadata.name}\n      #annotations:\n      #  cnrm.cloud.google.com/project-id: ${schema.spec.project}\n      name: ${schema.spec.name}\n    spec:\n      displayName: ${schema.spec.name}-eventarc-workflow\n- id: iampmEventarc\n  template:\n    apiVersion: iam.cnrm.cloud.google.com/v1beta1\n    kind: IAMPolicyMember\n    metadata:\n      labels:\n        enabled-service: ${iamEnable.metadata.name}\n      name: ${schema.spec.name}-eventarc\n    spec:\n      memberFrom:\n        serviceAccountRef:\n          name: ${iamsa.metadata.name}\n      role: roles/eventarc.admin\n      resourceRef:\n        kind: Project\n        external: ${schema.spec.project}\n- id: iampmWorkflow\n  template:\n    apiVersion: iam.cnrm.cloud.google.com/v1beta1\n    kind: IAMPolicyMember\n    metadata:\n      labels:\n        enabled-service: ${iamEnable.metadata.name}\n      name: ${schema.spec.name}-workflow\n    spec:\n      memberFrom:\n        serviceAccountRef:\n          name: ${iamsa.metadata.name}\n      role: roles/workflows.admin\n      resourceRef:\n        kind: Project\n        external: ${schema.spec.project}\n- id: topic\n  template:\n    apiVersion: pubsub.cnrm.cloud.google.com/v1beta1\n    kind: PubSubTopic\n    metadata:\n      labels:\n        enabled-service: ${pubsubEnable.metadata.name}\n      name: ${schema.spec.name}-gcs-finalizer-topic\n- id: bucket\n  template:\n    apiVersion: storage.cnrm.cloud.google.com/v1beta1\n    kind: StorageBucket\n    metadata:\n      labels:\n        enabled-service: ${storageEnable.metadata.name}\n      name: ${schema.spec.name}-${schema.spec.project}\n    spec:\n      uniformBucketLevelAccess: true\n- id: eventTrigger\n  template:\n    apiVersion: eventarc.cnrm.cloud.google.com/v1beta1\n    kind: EventarcTrigger\n    metadata:\n      labels:\n        enabled-service: ${eventarcEnable.metadata.name}\n      name: ${schema.spec.name}-gcsfinalizer\n    spec:\n      destination:\n        workflowRef:\n          external: "projects/${schema.spec.project}/locations/${schema.spec.location}/workflows/${schema.spec.workflowName}"\n      location: ${schema.spec.location}\n      serviceAccountRef:\n        name: ${iamsa.metadata.name}\n      transport:\n        pubsub:\n          topicRef:\n            name: ${topic.metadata.name}\n            namespace: config-connector\n      matchingCriteria:\n      - attribute: "type"\n        value: "google.cloud.pubsub.topic.v1.messagePublished"\n      projectRef:\n        external: "projects/${schema.spec.project}"\n- id: storageNotification\n  template:\n    apiVersion: storage.cnrm.cloud.google.com/v1beta1\n    kind: StorageNotification\n    metadata:\n      name: ${schema.spec.name}-gcs\n    spec:\n      bucketRef:\n        name: ${bucket.metadata.name}\n      topicRef:\n        name: ${topic.metadata.name}\n      eventTypes:\n      - "OBJECT_FINALIZE"\n      payloadFormat: JSON_API_V1\n'})})]})]})}function m(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},52502:(e,n,t)=>{t.d(n,{A:()=>a});const a=t.p+"assets/images/gcsbucket-with-finalizer-trigger-7c66747b9a921557185b6ddf349a6857.png"},28453:(e,n,t)=>{t.d(n,{R:()=>c,x:()=>o});var a=t(96540);const r={},i=a.createContext(r);function c(e){const n=a.useContext(i);return a.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),a.createElement(i.Provider,{value:n},e.children)}}}]);